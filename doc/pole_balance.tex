\documentclass{article}
\usepackage{amsmath, amsfonts, graphicx, fullpage}
\begin{document}
Consider a massless pole with a sphere attached to one end, with sphere mass being $m_s$. The other end of the pole (point $A$) is attached to the end-effector with mass $m_e$ at point $A$. The state of the system is the velocity of the end-effector point A $(\dot{x}_A, \dot{y}_A, \dot{z}_A)$, the delta position between the sphere and the end-effector in the horizontal plane $x_{AB} = x_B - x_A, y_{AB} = y_B-y_A$, together with its time derivative $\dot{x}_{AB}, \dot{y}_{AB}$.

\begin{figure}
	\centering
	\includegraphics[width=0.5\textwidth]{pole.pdf}
\end{figure}

The position of the mass is
\begin{align}
	\begin{bmatrix}
		x_A + x_{AB}\\
		y_A + y_{AB}\\
		z_A + \sqrt{l^2 - x_{AB}^2 - y_{AB}^2}
	\end{bmatrix}
\end{align}
The velocity of the mass is
\begin{align}
	\begin{bmatrix}
		\dot{x}_A + \dot{x}_{AB}\\
		\dot{y}_A + \dot{y}_{AB}\\
		\dot{z}_A - \frac{x_{AB}\dot{x}_{AB} + y_{AB}\dot{y}_{AB}}{\sqrt{l^2-x_{AB}^2 - y_{AB}^2}}
	\end{bmatrix}
\end{align}
The total kinetic energy of the system is
\begin{multline}
	T = 0.5 m_e (\dot{x}_A^2 + \dot{y}_A^2 +\dot{z}_A^2) + 0.5 m_s(\dot{x}_A^2 + \dot{y}_A^2 + \dot{z}_A^2 + \dot{x}_{AB}^2 + \dot{y}_{AB}^2 + \frac{(x_{AB}^2\dot{x}_{AB}^2 + y_{AB}^2\dot{y}_{AB}^2 + 2x_{AB}y_{AB}\dot{x}_{AB}\dot{y}_{AB})}{l^2-x_{AB}^2-y_{AB}^2}\\
	+ 2\dot{x}_A\dot{x}_{AB} + 2\dot{y}_A\dot{y}_{AB} - \frac{2\dot{z}_A(x_{AB}\dot{x}_{AB}+y_{AB}\dot{y}_{AB})}{\sqrt{l^2-x_{AB}^2-y_{AB}^2}})
\end{multline}
The total potential energy is
\begin{align}
	V = m_egz_A + m_sg(z_A + \sqrt{l^2-x_{AB}^2-y_{AB}^2})
\end{align}
Using Lagrangian $L = T-V$ and $\frac{d}{dt}\frac{\partial L}{\partial \dot{q}}-\frac{\partial L}{\partial q} = Bu$, we have
\begin{align}
	(m_e + m_s)\ddot{x}_A + m_s\ddot{x}_{AB} = u_x\\
	(m_e + m_s)\ddot{y}_A + m_s\ddot{y}_{AB} = u_y
\end{align}
\begin{multline}
	(m_e + m_s)(\ddot{z}_A+g) - m_s\left(\dot{x}_{AB}^2\frac{l^2 - y_{AB}^2}{z_{AB}^3} + \frac{x_{AB}}{z_{AB}}\ddot{x}_{AB} + \dot{y}_{AB}^2\frac{l^2-x_{AB}^2}{z_{AB}^3} + \frac{y_{AB}}{z_{AB}}\ddot{y}_{AB} - 2 \frac{x_{AB}y_{AB}\dot{x}_{AB}\dot{y}_{AB}}{z_{AB}^3}\right) = u_z
\end{multline}
\begin{multline}
	m_s(\ddot{x}_A + \ddot{x}_{AB}) - m_sx_{AB}(g+\ddot{z}_A)/z_{AB} + m_s(x_{AB}^2\ddot{x}_{AB}+x_{AB}\dot{x}_{AB}^2+x_{AB}y_{AB}\ddot{y}_{AB}+x_{AB}\dot{y}_{AB}^2)/z_{AB}^2\\
	+ m_s(x_{AB}^3\dot{x}_{AB}^2 + 2x_{AB}^2y_{AB}\dot{x}_{AB}\dot{y}_{AB} + x_{AB}y_{AB}^2\dot{y}_{AB}^2)/z_{AB}^4=0
\end{multline}
\begin{multline}
	m_s(\ddot{y}_A + \ddot{y}_{AB}) - m_sy_{AB}(g+\ddot{z}_A)/z_{AB} + m_s(y_{AB}^2\ddot{y}_{AB}+y_{AB}\dot{y}_{AB}^2+y_{AB}x_{AB}\ddot{x}_{AB}+y_{AB}\dot{x}_{AB}^2)/z_{AB}^2\\
	+ m_s(y_{AB}^3\dot{y}_{AB}^2 + 2y_{AB}^2x_{AB}\dot{y}_{AB}\dot{x}_{AB} + y_{AB}x_{AB}^2\dot{x}_{AB}^2)/z_{AB}^4=0
\end{multline}

In the matrix form, we have
\begin{align}
	M	\begin{bmatrix}\ddot{x}_A\\\ddot{y}_A\\\ddot{z}_A\\\ddot{x}_{AB}\\\ddot{y}_{AB}\end{bmatrix} + C = \begin{bmatrix}u_x\\u_y\\u_z\\0\\0\end{bmatrix}
\end{align}
where
\begin{align}
	M = 
	\begin{bmatrix}
		m_e + m_s & 0 & 0 & m_s & 0\\
		0 & m_e + m_s & 0 & 0 & m_s\\
		0 & 0 & m_e + m_s & -m_s\frac{x_{AB}}{z_{AB}} & -m_s\frac{y_{AB}}{z_{AB}}\\
		m_s& 0 & -m_s\frac{x_{AB}}{z_{AB}} & m_s + m_s\frac{x_{AB}^2}{z_{AB}^2} & m_s\frac{x_{AB}y_{AB}}{z_{AB}^2}\\
		0 & m_s & -m_s\frac{y_{AB}}{z_{AB}} &m_s\frac{x_{AB}y_{AB}}{z_{AB}^2} & m_s + m_s\frac{y_{AB}^2}{z_{AB}^2}
	\end{bmatrix}\\
	C = \begin{bmatrix}
		0\\
		0\\
		(m_e + m_s)g - m_s\left(\dot{x}_{AB}^2\frac{l^2-y_{AB}^2}{z_{AB}^3} + \dot{y}_{AB}^2\frac{l^2-x_{AB}^2}{z_{AB}^3} - 2\frac{x_{AB}y_{AB}\dot{x}_{AB}\dot{y}_{AB}}{z_{AB}^3}\right)\\
		-m_sg\frac{x_{AB}}{z_{AB}}+m_sx_{AB}\left(\frac{\dot{x}_{AB}^2 + \dot{y}_{AB}^2}{z_{AB}^2}+\frac{(x_{AB}\dot{x}_{AB} + y_{AB}\dot{y}_{AB})^2}{z_{AB}^4}\right)\\
		-m_sg\frac{y_{AB}}{z_{AB}}+m_sy_{AB}\left(\frac{\dot{x}_{AB}^2 + \dot{y}_{AB}^2}{z_{AB}^2}+\frac{(x_{AB}\dot{x}_{AB} + y_{AB}\dot{y}_{AB})^2}{z_{AB}^4}\right)
	\end{bmatrix}
\end{align}
\end{document}
